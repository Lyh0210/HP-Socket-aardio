import aaz.libhpsocket;
import aaz.libhpsocket.util.extra;

var _dll = aaz.libhpsocket._dll;

namespace aaz.libhpsocket.component.properties.agent;

_topointer = function(){
    return owner.pSocket; 
}

start = function(bindAddress, asyncConnect=true){
	if(_dll.HP_Agent_StartW(owner.pSocket, bindAddress, asyncConnect)){
		return true; 
	}
	return false, owner.lastError;
}
 
stop = function(){
	if(_dll.HP_Agent_Stop(owner.pSocket)){
		return true; 
	}
	return false, owner.lastError;
}

wait = function(milliseconds){
	if(_dll.HP_Agent_Wait(owner.pSocket, milliseconds)){
		return true; 
	}
	return false; 
}
	
connect = function(remoteAddress, port){
	var connId = {ADDR value};
	if(_dll.HP_Agent_ConnectW(owner.pSocket, remoteAddress, port, connId)){
		return connId.value;
	}
	return false; 	
}

connectWithExtra = function(remoteAddress, port, extra){
	var connId = {ADDR value};
	if(_dll.HP_Agent_ConnectWithExtraW(owner.pSocket, remoteAddress, port, connId, extra)){
		return connId.value;
	}
	return false; 
}

connectWithLocalPort = function(remoteAddress, port, localPort=0){
	var connId = {ADDR value};
	if(_dll.HP_Agent_ConnectWithLocalPortW(owner.pSocket, remoteAddress, port, connId, localPort)){
		return connId.value;
	}
	return false; 		
}

connectWithLocalAddress = function(remoteAddress, port, localAddress){
	var connId = {ADDR value}
	if(_dll.HP_Agent_ConnectWithLocalAddressW(owner.pSocket, remoteAddress, port, connId, localAddress)){
		return connId.value;
	}
	return false;		
}

connectWithExtraAndLocalPort = function(remoteIp, remotePort, extra, localPort=0){
	var connId = {ADDR value}
	if(_dll.HP_Agent_ConnectWithExtraAndLocalPortW(owner.pSocket,remoteIp, remotePort, connId, extra, localPort)){
		return connId.value;
	}	
	return false;		
}

connectWithExtraAndLocalAddressPort = function(remoteIp, remotePort, extra, localPort=0, localIp){
	var connId = {ADDR value}
	if(_dll.HP_Agent_ConnectWithExtraAndLocalAddressPortW(owner.pSocket, remoteIp, remotePort, connId, extra, localPort, localIp)){
		return connId.value;
	}	
	return false;		
}

send = function(connId, buffer, len){
	if(len){
		
	}
	elseif(buffer[["_struct"]]){
		len = ..raw.sizeof(buffer);
	}
	else {
		len = #buffer;
	}
	
	return _dll.HP_Agent_SendB(owner.pSocket, connId, buffer, len);
}

sendPart = function(connId, buffer, length, offset=0){
	if(length){
		
	}
	elseif(buffer[["_struct"]]){
		length = ..raw.sizeof(buffer);
	}
	else {
		length = #buffer;
	}
			
	if(_dll.HP_Agent_SendPartB( owner.pSocket, connId, buffer, length, offset)){
		return true; 
	}
	return false; 
}

pauseReceive = function(connId, pause){
	return _dll.HP_Agent_PauseReceiveB(owner.pSocket, connId, pause); 
}	
		
disconnect = function(connId, force){
	return _dll.HP_Agent_DisconnectB owner.pSocket, connId, force);
}

disconnectLongConnections = function(period,force){
	return _dll.HP_Agent_DisconnectLongConnectionsB(owner.pSocket, period, force);
}

disconnectSilenceConnections = function(period,force){
	return _dll.HP_Agent_DisconnectSilenceConnectionsB(owner.pSocket, period, force);
}	
	
setConnectionExtra = function(connId, pExtra){
	return _dll.HP_Agent_SetConnectionExtraB(owner.pSocket, connId, pExtra);
}

getConnectionExtra = function(connId){
 	var extra = {ptr value};
 		
	return 
		_dll.HP_Agent_GetConnectionExtraB(owner.pSocket, connId, extra), 
		extra.value;
}

getAllConnectionIds = function(){		
	var s = {
		ADDR array[] = { INT length } 
	};
	
	_dll.HP_Agent_GetAllConnectionIDs(owner.pSocket, null, s.array);
	if( s.array.length == 0 ){
		return true, s.array; 
	}

	return 
		_dll.HP_Agent_GetAllConnectionIDs(owner.pSocket, s, s.array), 
		s.array;
}

getConnectPeriod = function(connId){
	var s = {INT value} 
	if(_dll.HP_Agent_GetConnectPeriod(owner.pSocket, connId, s))
		return s.value;;
}

getSilencePeriod = function(connId){
	var s = {int value} 
	if(_dll.HP_Agent_GetSilencePeriod(owner.pSocket,connId,s))
		return s.value;;
}

getLocalAddress = function(connId){
	var addr ={ WORD value[60] };
	var addrlen = { int value=60 };
	var port = { WORD value };
	
	if(_dll.HP_Agent_GetLocalAddress(owner.pSocket, connId, addr, addrlen, port))
		return addr.value,port.value;
}

getRemoteAddress = function(connId){
	var addr ={ WORD value[60] };
	var addrlen = {int value=60 };
	var port = { WORD value };
	if(_dll.HP_Agent_GetRemoteAddress(owner.pSocket, connId, addr, addrlen, port))
		return addr.value, port.value;
}

getRemoteHost = function(connId){
	var addr ={ WORD value[60] };
	var addrlen = { int value=60 };
	var port = { WORD value };
	if(_dll.HP_Agent_GetRemoteHost(owner.pSocket, connId, addr, addrlen, port))
		return addr.value,port.value;
}

getPendingDataLength = function(connId){
	var s = { int value } 
	if( _dll.HP_Agent_GetPendingDataLength(owner.pSocket, connId, s))
		return s.value;; 
}

isPauseReceive = function( connId ){
	var result = { bool value };
	var ok = _dll.HP_Agent_IsPauseReceive(owner.pSocket, connId, result);
	return ok, result.value; 
}

isConnected = function(connId){
	return _dll.HP_Agent_IsConnectedB(owner.pSocket, connId);
}

isSecure = {
	_get = function(){
		return _dll.HP_Agent_IsSecureB(owner.pSocket);
	}
}

hasStarted = {
	_get = function(){
		return _dll.HP_Agent_HasStartedB(owner.pSocket);
	}
}

state = {
	_get = function(){
		return _dll.HP_Agent_GetState(owner.pSocket);
	}
}

connectionCount = {
    _get = function(){
    	return _dll.HP_Agent_GetConnectionCount(owner.pSocket); 
    }
}

lastError = {
    _get = function(){
    	return _dll.HP_Agent_GetLastError(owner.pSocket);
    }
}

lastErrorDesc = {
    _get = function(){
    	var p = _dll.HP_Agent_GetLastErrorDesc(owner.pSocket);
    	if(p){
    		return ..raw.str(p,true); 	
    	}
    }
}

reuseAddressPolicy = {
    _get = function(){
    	return _dll.HP_Agent_GetReuseAddressPolicy(owner.pSocket); 
    }
    
    _set = function(v){
    	_dll.HP_Agent_SetReuseAddressPolicy(owner.pSocket, v);
    } 
}

sendPolicy = {
    _get = function(){
    	return _dll.HP_Agent_GetSendPolicy(owner.pSocket); 
    }
    
    _set = function(v){
    	_dll.HP_Agent_SetSendPolicy(owner.pSocket, v);
    } 
}

onSendSyncPolicy = {
    _get = function(){
    	return _dll.HP_Agent_GetOnSendSyncPolicy(owner.pSocket); 
    }
    
    _set = function(v){
    	_dll.HP_Agent_SetOnSendSyncPolicy(owner.pSocket, v);
    } 
}

freeSocketObjLockTime = {
    _get = function(){
    	return _dll.HP_Agent_GetFreeSocketObjLockTime(owner.pSocket); 
    }
    
    _set = function(v){
    	_dll.HP_Agent_SetFreeSocketObjLockTime(owner.pSocket, v);
    } 
}

freeSocketObjPool = {
    _get = function(){
    	return _dll.HP_Agent_GetFreeSocketObjPool(owner.pSocket); 
    }
    
    _set = function(v){
    	_dll.HP_Agent_SetFreeSocketObjPool(owner.pSocket, v);
    } 
}

freeBufferObjPool = {
    _get = function(){
    	return _dll.HP_Agent_GetFreeSocketObjPool( owner.pSocket ); 
    }
    
    _set = function(v){
    	_dll.HP_Agent_SetFreeBufferObjPool( owner.pSocket, v );
    } 
}

freeSocketObjHold = {
    _get = function(){
    	return _dll.HP_Agent_GetFreeBufferObjPool(owner.pSocket); 
    }
    
    _set = function(v){
    	_dll.HP_Agent_SetFreeSocketObjHold(owner.pSocket, v);
    } 
}

freeBufferObjHold = {
    _get = function(){
    	return _dll.HP_Agent_GetFreeBufferObjHold(owner.pSocket); 
    }
    
    _set = function(v){
    	_dll.HP_Agent_SetFreeBufferObjHold(owner.pSocket, v);
    } 
}

maxConnectionCount = {
    _get = function(){
    	return _dll.HP_Agent_GetMaxConnectionCount(owner.pSocket); 
    }
    
    _set = function(v){
    	_dll.HP_Agent_SetMaxConnectionCount(owner.pSocket, v);
    } 
}

workerThreadCount = {
    _get = function(){
    	return _dll.HP_Agent_GetWorkerThreadCount(owner.pSocket); 
    }
    
    _set = function(v){
    	_dll.HP_Agent_SetWorkerThreadCount(owner.pSocket, v);
    } 
}

isMarkSilence = {
    _get = function(){
    	return _dll.HP_Agent_IsMarkSilenceB(owner.pSocket); 
    }
    
    _set = function(v){
    	_dll.HP_Agent_SetMarkSilence(owner.pSocket, v); 
    }
}

reallocString = function(connId, size=0){
	var ok, pExtra = owner.getConnectionExtra(connId); 
	if( ok ){
		return owner.setConnectionExtra(connId, ..raw.realloc(size, pExtra, "")); 	
	} 
}

appendString = function(connId,pData,len){
	var ok, pExtra = owner.getConnectionExtra(connId);
	if(pExtra) 
		return owner.setConnectionExtra(connId, ..raw.concat(pExtra, pData, len));  
}

getString = function(connId){
	var ok, pExtra = owner.getConnectionExtra(connId); 
	if(pExtra){
		var size = ..raw.sizeof(pExtra);
		if(size) return ..raw.tostring(pExtra, 1, size);
	}
}